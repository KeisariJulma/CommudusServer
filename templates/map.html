<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPS Map</title>
<style>
  #map { height: 80vh; width: 100%; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<h2>GPS Map</h2>
<select id="groupSelect"></select>
<div id="map"></div>

<script>
let map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let markers = {};
let selectedGroup = null;

// Load groups dynamically
fetch("/groups_json")
  .then(res => res.json())
  .then(groups => {
      let select = document.getElementById("groupSelect");
      groups.forEach(g => {
          let option = document.createElement("option");
          option.value = g;
          option.text = g;
          select.appendChild(option);
      });
      // Default to first group
      if(groups.length) {
          selectedGroup = groups[0];
          startSSE();
      }
  });

document.getElementById("groupSelect").addEventListener("change", (e) => {
    selectedGroup = e.target.value;
    // Clear existing markers
    Object.values(markers).forEach(m => map.removeLayer(m));
    markers = {};
});

// SSE for live updates
function startSSE() {
    if(!selectedGroup) return;
    const evtSource = new EventSource(`/stream?group=${selectedGroup}`);
    evtSource.onmessage = function(e) {
        let data = JSON.parse(e.data);
        for(let name in data) {
            let dev = data[name];
            let lat = dev.lat;
            let lon = dev.lon;
            if(markers[name]) {
                markers[name].setLatLng([lat, lon]);
            } else {
                let marker = L.marker([lat, lon]).addTo(map).bindPopup(name);
                markers[name] = marker;
            }
        }
    }
}
</script>
</body>
</html>
