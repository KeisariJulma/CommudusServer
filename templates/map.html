<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Real-Time Device Map</title>
<script src="https://unpkg.com/maplibre-gl@2.6.1/dist/maplibre-gl.js"></script>
<link
  href="https://unpkg.com/maplibre-gl@2.6.1/dist/maplibre-gl.css"
  rel="stylesheet"
/>
<style>
  body, html { margin: 0; padding: 0; height: 100%; }
  #map { width: 100%; height: 100%; }
  .marker {
    background-color: purple;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid white;
    text-align: center;
    line-height: 20px;
    color: white;
    font-weight: bold;
    font-size: 12px;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
  // Initialize map
  const map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {
        osm: {
          type: 'raster',
          tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
          tileSize: 256
        }
      },
      layers: [{
        id: 'osm',
        type: 'raster',
        source: 'osm'
      }]
    },
    center: [0, 0],
    zoom: 2
  });

  const markers = {};

  // Remove devices not updated in last 10 seconds
  const MAX_AGE_MS = 10000;

  // Connect to SSE stream
  const evtSource = new EventSource("/stream");
  evtSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const now = Date.now();

    // Remove old markers
    for (const id in markers) {
      const markerInfo = markers[id].lastUpdated;
      if (now - markerInfo > MAX_AGE_MS) {
        markers[id].marker.remove();
        delete markers[id];
      }
    }

    // Update/add markers
    for (const id in data) {
      const dev = data[id];
      if (!dev.lat || !dev.lon) continue;

      if (!markers[id]) {
        const el = document.createElement('div');
        el.className = 'marker';
        el.textContent = dev.name || id;

        const marker = new maplibregl.Marker(el)
          .setLngLat([dev.lon, dev.lat])
          .addTo(map);

        markers[id] = { marker, lastUpdated: now };
      } else {
        markers[id].marker.setLngLat([dev.lon, dev.lat]);
        markers[id].lastUpdated = now;
      }
    }
  };
</script>
</body>
</html>
