<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Device Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://unpkg.com/maplibre-gl@2.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { width:100%; height:100%; }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@2.6.1/dist/maplibre-gl.js"></script>
<script>
const map = new maplibregl.Map({
    container: 'map',
    style: 'https://demotiles.maplibre.org/style.json',
    center: [0, 0],
    zoom: 2
});

// Store markers so we can update/remove them
const markers = {};

// Listen to the server-sent events
const evtSource = new EventSource('/stream');
evtSource.onmessage = function(e) {
    const devices = JSON.parse(e.data);

    // Remove old markers
    for (const id in markers) {
        if (!devices[id]) {
            markers[id].remove();
            delete markers[id];
        }
    }

    // Add/update markers
    for (const [id, info] of Object.entries(devices)) {
        const { lat, lon, name, heading } = info;
        if (!lat || !lon) continue;

        if (!markers[id]) {
            // create marker
            const el = document.createElement('div');
            el.style.background = 'purple';
            el.style.width = '18px';
            el.style.height = '18px';
            el.style.borderRadius = '50%';
            el.style.border = '2px solid white';
            el.title = `${name}\n${heading ?? '?' }Â°`;

            markers[id] = new maplibregl.Marker(el)
                .setLngLat([lon, lat])
                .addTo(map);

            // Add popup with name
            const popup = new maplibregl.Popup({ offset: 25 })
                .setText(name);
            markers[id].setPopup(popup);
        } else {
            markers[id].setLngLat([lon, lat]);
        }
    }
};
</script>
</body>
</html>
