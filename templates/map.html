<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live Device Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html, body, #map { margin: 0; padding: 0; height: 100%; width: 100%; }
  .marker {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: purple;
    border: 2px solid white;
    text-align: center;
    line-height: 24px;
    color: white;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
  }
</style>
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
</head>
<body>
<div id="map"></div>
<script>
const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      osm: {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256
      }
    },
    layers: [{
      id: 'osm-layer',
      type: 'raster',
      source: 'osm'
    }]
  },
  center: [0, 0],
  zoom: 2
});

const markers = {};
const bounds = new maplibregl.LngLatBounds();

// Connect to SSE for live updates
const evtSource = new EventSource('/stream');
evtSource.onmessage = function(event) {
  const devices = JSON.parse(event.data);

  // Remove stale markers
  for (let id in markers) {
    if (!devices[id]) {
      markers[id].remove();
      delete markers[id];
    }
  }

  // Add/update markers
  bounds.clear();
  for (let id in devices) {
    const dev = devices[id];
    const coords = [dev.lon, dev.lat];
    if (!coords[0] || !coords[1]) continue;

    let marker = markers[id];
    if (!marker) {
      const el = document.createElement('div');
      el.className = 'marker';
      el.innerText = dev.name[0] || id[0]; // first letter
      marker = new maplibregl.Marker(el)
        .setLngLat(coords)
        .setPopup(new maplibregl.Popup({ offset: 25 })
          .setHTML(`<b>${dev.name}</b><br>Heading: ${dev.heading ?? "?"}°`))
        .addTo(map);
      markers[id] = marker;
    } else {
      // Smoothly move marker
      marker.setLngLat(coords);
      if (marker.getPopup()) {
        marker.getPopup().setHTML(`<b>${dev.name}</b><br>Heading: ${dev.heading ?? "?"}°`);
      }
    }

    bounds.extend(coords);
  }

  // Fit map to all devices if any exist
  if (Object.keys(devices).length > 0) {
    map.fitBounds(bounds, { padding: 100, maxZoom: 16, animate: true });
  }
};
</script>
</body>
</html>
