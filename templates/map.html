<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GPS Map</title>
<style>
  #map { height: 80vh; width: 100%; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
<h2>GPS Map</h2>
<select id="groupSelect"></select>
<div id="map"></div>

<script>
let map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

let markers = {};

// Connect to the stream that shows everyone
const evtSource = new EventSource("/stream");

evtSource.onmessage = function(e) {
    let data = JSON.parse(e.data);

    // Remove markers for devices no longer active
    for (let name in markers) {
        if (!data[name]) {
            map.removeLayer(markers[name]);
            delete markers[name];
        }
    }

    // Update or create markers
    for (let name in data) {
        let dev = data[name];
        if (!dev.lat || !dev.lon) continue;
        if (markers[name]) {
            markers[name].setLatLng([dev.lat, dev.lon]);
        } else {
            markers[name] = L.marker([dev.lat, dev.lon])
                .addTo(map)
                .bindPopup(`${name}<br>(${dev.lat.toFixed(4)}, ${dev.lon.toFixed(4)})`);
        }
    }
};
</script>
</body>
</html>
